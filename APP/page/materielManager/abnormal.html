<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.css" rel="stylesheet" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/common.css" type="text/css" charset="utf-8" />
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/jquery-3.4.1.js"></script>
		<script type="text/javascript" src="../../js/common.js"></script>
		<style type="text/css">
			.aname {
				font-size: 16px;
			}

			.ainf {
				font-size: 12px;
			}

			.iplay {
				display: block;
				background: no-repeat right center url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABYCAYAAAADWlKCAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAKwwAACsMBNCkkqwAAABZ0RVh0Q3JlYXRpb24gVGltZQAwOS8xMi8xM5w+I3MAAAAcdEVYdFNvZnR3YXJlAEFkb2JlIEZpcmV3b3JrcyBDUzVxteM2AAAD9UlEQVR4nO2b3XETMRRGDwzvoYOkg5hRAVkqiKmAdIA7wHSQVECoALsC1gXciV0BTge4gvCwgnHk9d/+WF8m97ztxrlXs8fS1Urym6enJxwd3uZugPMcFyKGCxHDhYjhQsRwIWK4EDFciBguRAwXIoYLEcOFiOFCxHAhYrgQMVyIGC5EDBcihgsRw4WI4ULEcCFiuBAx3uVuwDGY2XtgCBTAALjc8tEFMAdKYBJC+HOK9nXBm5dwUM7MCmAEXDcMMQVuQwhlV23qC2khZjYAboGrjkLOgFEIYd5RvM6RrSFmdgs80J0MYqyHGFsSuR4S60TJ9vrwCEziZ+YhhGXy/xdU9aWgqjfnW+IsgEKtvkgJiUPUPfUyZsD42DoQ68+Y+p62AG6UhjAZITt6xopq3L9vGf+Gqh6dJX+S6ilKNaRkU8YCGLSVARBjDGLMdS5jbgkkhMQiWyejSGtEG2KsghopKoU++5AV68ZDcrvXYWTH8Pghdz1R6CHpN3MFDPsc02PsYcy1qy0nJ6uQOANKZz+jfcOUmd3H6W1jYo5RcvsqtikbuXtI+kBmBxbwz8DczMZtksdcsz1tOinZhMRxPF2bGh8R4gz4amZLMxu2aEqa8zq2LQs5e0j6EB8bLv6dAz/NrGwyjMWcj3vadjJyCimS60nLeFfAbzO7bfANT3MXLdvSmJxCBsl12VHcL8AyvpkfSpo7bdvJyCkkfQfocv5/Bnw3s/mBs6Y097aFzd7JPcv6T5dv5GtcAr/2TZN7yt0IGSE908k0+RS8FiEvhhd1yKEFUw5YAVBApoe0XQrZwgL4GEIY7pLRU+5G5OwhC57PZgbAsqPYK6rdxUMXC9Npbro8fzJy9pB0qll0FPcOuDhCRl3ubEvwOYWUyXXb5YoZ1X7GqMHSfZq7bNmWxuQUki5XnDdc+n4EPoUQiiabSzFnejKl7TJOY7IJid/iaXJ7fESIFfCNas+9zQNMc05zHnjIPctKx/mrA9egflCJGLd5eDFXukGWdddQYU+95PlDWVE97GXPeS+oivf6saBZCKHoM+8+cvcQ2NyhOwMmfW4SxdgTNs9oZd0tBAEhsRDfJbcvgbIPKTtOnNzlPnECAkPWP8xsTv3ZrJ1v2UfmuKDqGRt5QgjZ9kDWyd5D1iioP1U4P3KzqZYYY5v0om38rpDpIeCHrUFMCPjPEeSE/COetf3SU/i7EEL2GVUdSjXkGfGBfWDzIFsb/q93dRizU2R7yDr+o09R/GfRzsmRrSGvFRcihgsRw4WI4ULEcCFiuBAxXIgYLkQMFyKGCxHDhYjhQsRwIWK4EDFciBguRAwXIoYLEcOFiOFCxHAhYrgQMf4CVuqCm+17t3sAAAAASUVORK5CYII=);
				background-size: 50px 44px;
				-ms-touch-action: auto;
			}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav" style="padding-right: 15px;">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">异常处理</h1>
			<!-- <span class="mui-pull-right mui-icon mui-icon-home"></span> -->
		</header>
		<div class="mui-content" id="abnormalIndex">
			<div class="mui-content-padded">
				<h4 class="mui-pull-left"><span style="color: #F56C6C;margin-right: 4px;">*</span>解决办法：</h4>
				<div class="mui-input-row" style="margin: 10px 5px;">
					<textarea v-model="CbMemo" rows="5" placeholder=""></textarea>
					<div id="text" style="color: #F56C6C;font-size: 14;"></div>
				</div>
				<div v-show="showPicture" class="mui-input-row">
					<h4 class="mui-pull-left">图片：</h4>
					<div class="mui-scroll-wrapper" :style="{position: 'static',backgroundColor: 'white',height: centerHeight+'px'}">
						<div class="mui-scroll" style="position: static;padding: 10px;">
							<div v-for="(item,i) in pictureIdList">
								<div class="mui-media-body">
									图片：{{i+1}}
								</div>
								<img :src=item.url :style="{width:centerWidth+'px'}" v-on:tap="list(item.upId)" />
							</div>
						</div>
					</div>
				</div>

				<br />
				<br />
				<p> 	<a href="#picture" class="button"  style="padding: 5px 20px;">图片上传</a></p>
				<br />
				<!-- History list -->
				<ul id="history" class="dlist" style="display: none;">
					<li id="empty"></li>
				</ul>
				<br />
				<br />
			</div>
			<div id="picture" class="mui-popover mui-popover-action mui-popover-bottom">
				<ul class="mui-table-view">
					<li class="mui-table-view-cell">
						<a href="#" @click="getImage">拍照</a>
					</li>
					<li class="mui-table-view-cell">
						<a href="#" @click="getCompImage">从相册选择</a>
					</li>
				</ul>
				<ul class="mui-table-view">
					<li class="mui-table-view-cell">
						<a href="#picture"><b>取消</b></a>
					</li>
				</ul>
			</div>
			<button @click="save" type="primary" class="mui-btn mui-pull-right" style="font-size: 15px;margin: .5em .7em;">
				保存
			</button>
		</div>
		<script src="../../js/vue/vue.js"></script>
		<script src="../../js/muiMethods.js"> </script>
		<script src="../../../js/element/index.js"></script>
		<script type="text/javascript">
			var vm = new Vue({
				el: '#abnormalIndex',
				data: {
					centerHeight: '',
					height: '',
					centerWidth: '',
					wight: '',
					CbMemo: '',
					isUploiad: false,
					showPicture: false,
					pictureIdList: [], //图片--
					formData: [],
					rowData: {},
					userId: '',
					bUpdated: false,
					gentry: null,
					i: 1,
					w: null,
					hl: null,
					de: null,
					ie: null,
					unv: true
				},
				mounted: function() {
					mui.init({
						beforeback: function() {
							//获得父页面的webview
							var list = plus.webview.currentWebview().opener();
							//触发父页面的自定义事件(refresh),从而进行刷新
							mui.fire(list, 'refresh');
							//返回true,继续页面关闭逻辑
							return true;
						}
					})
					mui.plusReady(function() {
						//获取手机高度
						vm.height = document.documentElement.clientHeight || document.body.clientHeight;
						vm.wight = document.documentElement.clientWidth || document.body.clientWidth;
						vm.centerHeight = vm.height * 0.5;
						vm.centerWidth = vm.wight * 0.8;
						vm.rowData = JSON.parse(localStorage.getItem('rowData'));
						mui('.mui-scroll-wrapper').scroll({
							scrollY: true, //是否竖向滚动
							scrollX: true, //是否横向滚动
							startX: 0, //初始化时滚动至x
							startY: 0, //初始化时滚动至y
							indicators: true, //是否显示滚动条
							bounce: false, //是否启用回弹,
							deceleration: 0.0005
						});
						if (mui.os.plus) {
							mui.plusReady(function() {
								vm.getAjaxData(vm.rowData.Aeid);
							})
						} else {
							vm.getAjaxData(vm.rowData.Aeid);
						}
					});
					// 监听DOMContentLoaded事件
					document.addEventListener('DOMContentLoaded', function() {
						// 获取DOM元素对象
						vm.hl = document.getElementById('history');
						vm.le = document.getElementById('empty');
						vm.de = document.getElementById('display');
						if (vm.ie = document.getElementById('index')) {
							vm.ie.onchange = vm.indexChanged;
						}
						// 判断是否支持video标签
						vm.unv = !document.createElement('video').canPlayType;
						vm.updateHistory();
					}, false);
				},
				methods: {
					//删除图片
					list: function(item) {
						var btnArray = ['否', '是'];
						mui.confirm('是否删除照片？', '', btnArray, function(e) {
							// 否：e.index=0;是：e.index=1;
							if (e.index == 1) {
								//删除图片
								vm.deleteOnePicture(item);
							} else {
								mui.toast('已取消');
							}
						})
					},
					deleteOnePicture: function(id) {
						mui.ajaxRequest('shyh.app/Goods/DelFile?secretkey_for_vmwebapi=0987654321&appkey_for_vmwebapi=VMT-EM&upid=' +
							id, {
								type: "get",
								success: function(data) {
									if (JSON.stringify(data.code) == 0) {
										mui.toast('删除成功！');
										vm.isUploiad = true;
										vm.getAjaxData(vm.rowData.Aeid);
									}
								},
								error: function(data) {
									mui.toast('删除失败！')
								}
							});
					},
					getAjaxData: function(Aeid) {
						//每次查询图片时先清空
						vm.pictureIdList = [];
						vm.userId = JSON.parse(localStorage.getItem('userInfo')).UserId;
						// vm.cleanHistoryFirst();//处理拍照图片缓存
						//-----------表格数据
						mui.ajaxRequest(
							'shyh.app/Goods/GetTaskInfo?secretkey_for_vmwebapi=0987654321&appkey_for_vmwebapi=VMT-EM&aeid=' + Aeid + '', {
								type: "get",
								success: function(data) {
									if (JSON.stringify(data.code) == 0) {
										vm.formData = data.data;
										if (!(vm.isUploiad)) {
											vm.CbMemo = vm.formData.CbMemo;
										}
										//加载图片
										vm.gentry = null;
										var upId = data.data.Upids;
										if (upId.length > 0) {
											vm.showPicture = true;
											for (var i in upId) {
												let src = mui.baseUrl +
													'shyh.app/Goods/DownFile?secretkey_for_vmwebapi=0987654321&appkey_for_vmwebapi=VMT-EM&upid=' + upId[i] +
													'';
												let rowData = {};
												rowData['url'] = src;
												rowData['upId'] = upId[i];
												vm.pictureIdList.push(rowData);
											}
										} else {
											vm.pictureIdList = [];
											vm.showPicture = false;
										}
									}
								},
								error: function(data) {
									mui.toast('erro')
								}
							});
					},
					getCompImage:function(){ 
						//关闭操作列表
						mui('#picture').popover('toggle');
						plus.gallery.pick(function(e){
							for(var i in e.files){
						    	console.log(e.files[i]);
								vm.uploadFile(e.files[i]);
							}
						}, function(e){
							mui.toast('取消选择图片');
						},{filter:'image',multiple:true,system:false});
					},
					// 拍照
					getImage: function() {
						//关闭操作列表
						mui('#picture').popover('toggle');
						// outSet('开始拍照：');
						var cmr = plus.camera.getCamera();
						cmr.captureImage(function(p) {
							// outLine('成功：'+p); 
							vm.uploadFile(p);
						}, function(e) { 
							// outLine('失败：'+e.message);
						}, {
							filename: '_doc/camera/',
							index: 1
						});

					},
					uploadFile:function(p){
						plus.io.resolveLocalFileSystemURL(p, function(entry) {
							vm.createItem(entry);
							var wt = plus.nativeUI.showWaiting();
							var task = plus.uploader.createUpload(mui.baseUrl +
								'shyh.app/Person/UploadFile?secretkey_for_vmwebapi=0987654321&appkey_for_vmwebapi=VMT-EM&Code=' + vm.rowData
								.Code + '&userId=' + vm.userId, {
									method: "post"
								},
								function(t, status) {
									//上传完成
									if (status == 200) {
										// alert("上传成功："+t.responseText);
										mui.toast("上传成功!")
										wt.close(); //关闭等待提示按钮
										vm.isUploiad = true;
										vm.getAjaxData(vm.rowData.Aeid);
									} else {
										// alert("上传失败："+status);
										mui.toast("上传失败!")
										wt.close(); //关闭等待提示按钮
									}
								}
							);
							task.addFile(entry.toLocalURL(), {
								key: entry.toLocalURL()
							});
							task.start();
						}, function(e) {
							// outLine('读取拍照文件错误：'+e.message);
						});
					},
					// 添加播放项
					createItem: function(entry) {
						var li = document.createElement('li');
						li.className = 'ditem';
						li.innerHTML = '<span class="iplay"><font class="aname"></font><br/><font class="ainf"></font></span>';
						li.setAttribute('onclick', 'vm.displayFile(this)');
						vm.hl.insertBefore(li, vm.le.nextSibling);
						li.querySelector('.aname').innerText = entry.name;
						li.querySelector('.ainf').innerText = '...';
						li.entry = entry;
						vm.updateInformation(li);
						// 设置空项不可见
						vm.le.style.display = 'none';
					},
					// 获取录音文件信息
					updateInformation: function(li) {
						if (!li || !li.entry) {
							return;
						}
						var entry = li.entry;
						entry.getMetadata(function(metadata) {
							li.querySelector('.ainf').innerText = dateToStr(metadata.modificationTime);
						}, function(e) {
							// outLine('获取文件"'+entry.name+'"信息失败：'+e.message);
						});
					},
					// 获取录音历史列表
					updateHistory: function() {
						if (vm.bUpdated || !vm.gentry || !document.body) { //兼容可能提前注入导致DOM未解析完更新的问题
							return;
						}
						// for(var i in vm.gentry){
						// 	console.log(vm.gentry[i])
						// }
						var reader = vm.gentry.createReader();
						reader.readEntries(function(entries) {
							for (var i in entries) {
								if (entries[i].isFile) {
									vm.createItem(entries[i]);
								}
							}
						}, function(e) {
							// outLine('读取录音列表失败：'+e.message);
						});
						vm.bUpdated = true;
					},
					indexChanged: function() {
						vm.de.innerText = vm.ie.options[vm.ie.selectedIndex].innerText;
						vm.i = parseInt(vm.ie.value);
						// outLine(vm.de.innerText);
					},
					// 显示文件
					displayFile: function(li) {
						if (vm.w) {
							// outLine('重复点击！');
							return;
						}
						if (!li || !li.entry) {
							ouSet('无效的媒体文件');
							return;
						}
						var name = li.entry.name;
						var suffix = name.substr(name.lastIndexOf('.'));
						var url = '';
						if (suffix == '.mov' || suffix == '.3gp' || suffix == '.mp4' || suffix == '.avi') {
							//if(unv){plus.runtime.openFile('_doc/camera/'+name);return;}
							url = '/plus/camera_video.html';
						} else {
							url = '/plus/camera_image.html';
						}
						vm.w = plus.webview.create(url, url, {
							hardwareAccelerated: true,
							scrollIndicator: 'none',
							scalable: true,
							bounce: 'all'
						});
						vm.w.addEventListener('loaded', function() {
							vm.w.evalJS('loadMedia("' + li.entry.toLocalURL() + '")');
							//w.evalJS('loadMedia("'+'http://localhost:13131/_doc/camera/'+name+'")');
						}, false);
						vm.w.addEventListener('close', function() {
							vm.w = null;
						}, false);
						vm.w.show('pop-in');
					},
					// 清除历史记录
					cleanHistoryFirst: function() {
						vm.hl.innerHTML = '<li id="empty" class="ditem-empty">无历史记录</li>';
						vm.le = document.getElementById('empty');
						// 删除音频文件
						// outSet('清空拍照录像历史记录：');
						vm.gentry.removeRecursively(function() {
							// Success
							// outLine('成功！');
						}, function(e) {
							// outLine('失败：'+e.message);
						});
					},
					// 清除历史记录
					cleanHistory: function() {
						vm.hl.innerHTML = '<li id="empty" class="ditem-empty">无历史记录</li>';
						vm.le = document.getElementById('empty');
						// 删除音频文件
						// outSet('清空拍照录像历史记录：');
						vm.gentry.removeRecursively(function() {
							// Success
							// outLine('成功！');
						}, function(e) {
							// outLine('失败：'+e.message);
						});

					},
					save: function() {
						if (!vm.CbMemo) {
							document.getElementById("text").innerHTML = "诊断内容不能为空！";
						} else {
							document.getElementById("text").innerHTML = "";
							vm.userId = JSON.parse(localStorage.getItem('userInfo')).UserId;
							mui.ajaxRequest('shyh.app/Goods/DealTask?secretkey_for_vmwebapi=0987654321&appkey_for_vmwebapi=VMT-EM&aeid=' +
								vm.rowData.Aeid + '&recMan=' + vm.userId + '&recTime=' + vm.rowData.CallDate + '&memo=' + vm.CbMemo +
								'&recManUserName=' + vm.rowData.CallMan + '', {
									type: "Post",
									success: function(data) {
										if (data.code == -1) {
											mui.toast('参数错误！');
										} else {
											mui.toast('提交成功');
											mui.back();
										}
									},
									error: function(xhr) {
										// mui.toast(JSON.stringify(JSON.parse(xhr.response).message),{ duration:'long'});
									}
								});
						}
					}
				}
			})
		</script>
	</body>

</html>
